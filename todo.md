# TODO для VK → Telegram бота

## Подготовка
- [ ] Выбрать Python 3.11+, создать venv, зафиксировать `pip freeze > requirements.txt` (минимум библиотек).
- [ ] Получить токены: `VK_GROUP_TOKEN` (scope wall, photos, video, groups), `TG_BOT_TOKEN`, `TG_CHANNEL_ID`, `OWNER_ID`. Занести в `.env.example`.
- [ ] Настроить `pre-commit` (опционально) с базовыми проверками `ruff/flake8` и `black` при необходимости.
- [ ] Настроить статический анализ (минимум: `ruff` + `mypy`), чтобы ловить ошибки типов/импортов до запуска.
- [ ] Добавить конфиг-флаг `MODERATION_MODE` (`required`/`off`) и значения по умолчанию.

## Базовая структура проекта
- [ ] Создать пакеты `bot/` с модулями `config.py`, `logging_setup.py`, `state.py`, `vk_client.py`, `tg_client.py`, `pipeline.py`, `main.py`.
- [ ] Реализовать загрузку конфигурации из env + CLI аргументы (например, `--dry-run`).
- [ ] Настроить логирование: stdout + rotating file `logs/bot.log`, уровни INFO/ERROR, фильтр токенов.
- [ ] Добавить простейшее хранилище состояния (`state.json` или SQLite) и абстракцию с блокировкой на запись.

## VK: получение событий
- [ ] Написать клиент для `groups.getLongPollServer` + хранение `ts/key/server`.
- [ ] Реализовать цикл Long Poll с ретраями и обработкой ошибок (timeout, `failed=1/2/3`).
- [ ] Добавить fallback `wall.get` (N последних записей) для восстановления после рестарта.
- [ ] Обработать новое событие (`wall_post_new`): в пайплайн, логировать trace-id, проверять тип поста (отбрасывать `suggest`, `postpone`).
- [ ] Юнит-тест: мок `httpx` для `wall_post_new` → событие приходит в обработчик.

## Нормализация данных
- [ ] Функции экранирования для HTML/MarkdownV2, обрезка текста >4096 с переносом в несколько сообщений.
- [ ] Парсер вложений: фото (выбор лучшего размера), видео (player/url + превью), опросы (вопрос, опции, флаги).
- [ ] Обработка `copy_history` (перепосты): слить текст, добавить ссылку на источник, собрать медиа.
- [ ] Тесты: фикстуры VK событий с фото/видео/опросом/длинным текстом → ожидаемый нормализованный payload.

## Telegram: отправка
- [ ] Клиент с методами `send_message`, `send_photo`, `send_media_group`, `send_video`, `send_poll`, `notify_owner`.
- [ ] Лимитирование: последовательная отправка медиагруппы (caption у первого элемента), проверка размера/типа вложений.
- [ ] Ошибки API: обработка 429 (`retry_after`), 400/403/404 — лог + уведомление владельца.
- [ ] Интеграционный тест: мок Telegram API, проверить порядок вызовов и содержимое payload.

## Состояние и дедупликация
- [ ] Поддерживать `last_post_id` и кольцевой буфер последних N post_ids для защиты от повторов.
- [ ] Хранить `ts` long poll для быстрого восстановления.
- [ ] Добавить хэш (текст+вложения) и словарь `post_id -> tg_message_ids` для обновления/пропуска при редактировании.
- [ ] Тест: симулировать рестарт — убедиться, что старые посты не отправляются повторно.
- [ ] Тест: повторное событие с тем же `post_id` и неизменным хэшем — нет повторной отправки. При изменённом хэше — либо edit, либо лог и пропуск (согласно режиму).

## Оркестрация/пайплайн
- [ ] Главный цикл: получить событие → нормализовать → отправить в TG → обновить состояние.
- [ ] Встроенный `--dry-run` режим: только логирование действий без отправки.
- [ ] Метрики в логах: количество постов, отправленных медиа, ошибки, время обработки.
- [ ] Кейсы медиа: 1 фото → `sendPhoto`, >=2 медиа → `sendMediaGroup`; опрос — отдельным запросом. Проверить, что текст + содержимое переносится в TG.
- [ ] Добавить пайплайн модерации: при `MODERATION_MODE=required` отправлять предпросмотр владельцу (inline-кнопки approve/reject), по approve — публикация в канал, по reject — отметка в состоянии.
- [ ] Состояние модерации: хранить `post_id -> {status, token, tg_message_ids?, hash}`. Инвалидировать старые токены при новом событии с изменённым хэшем.
- [ ] Тест: повторное событие в статусе `pending` без изменений — не слать повторный предпросмотр. Изменилось — слать новый, старый token не валиден.

## Парсер новостей alumni (https://www.econ.msu.ru/alumni/)
- [ ] Клиент для страницы списка: запрос главной alumni, парсинг блоков `.aef_news_text`/`h3.news_text a`, дата из `.title_text .date`.
- [ ] Парсер деталки: по относительной ссылке получить текст (очистить HTML) и список изображений (`<img>`, ссылки `raw.php` → абсолютные URL).
- [ ] Дедуп: хранить `news_seen` (URL) в state; отправлять только новые. Интеграция с ручным refresh.
- [ ] Отправка: сформировать текст (дата + заголовок + ссылка), прикрепить до 10 фото медиагруппой; лишние фото — ссылками.
- [ ] Отдельный воркер/планировщик: периодический опрос (10–15 мин) + реакция на кнопку «Обновить посты».
- [ ] Обработка ошибок: при 5 одинаковых ошибках подряд — уведомление владельцу и остановка воркера.
- [ ] Тесты: парсинг списка/деталки, дедуп по URL, корректный формат ссылки без лишних символов, отправка медиагруппы.

## Уведомления и обработка ошибок
- [ ] Глобальный перехватчик исключений: лог + `notify_owner` (с трейсом, усеченным до N строк).
- [ ] Ретраи с экспоненциальной задержкой и джиттером на сетевые ошибки.
- [ ] Тест: форсировать ошибку Telegram/VK → проверить, что ушло уведомление владельцу и запись в лог.

## Деплой и эксплуатация
- [ ] Добавить скрипт запуска `python -m bot` и пример `systemd` unit (`deploy/botvktg.service`).
- [ ] Подготовить `Makefile`/скрипт `run.sh` (создать venv, установить deps, запустить).
- [ ] Описать локацию логов и политику ротации; проверить права на запись.
- [ ] Пробный прогон в `dry-run` с реальным `wall.get` (без отправки) — убедиться, что парсинг корректен.
- [ ] Включить режим регулярного health-лога/уведомлений (настройка интервала) и реагирование на N подряд ошибок.

## Документация и финальная проверка
- [ ] Обновить `design.md`/README по факту реализации.
- [ ] Сводный чеклист перед продом: токены, доступ бота к каналу, время сервера/TZ, автозапуск systemd, логи пишутся, уведомления владельцу работают.
- [ ] Финальный e2e тест: опубликовать тестовый пост в ВК → проверить доставку в канал (текст+медиа+опрос).
- [ ] Финальный тест на редактирование: изменить пост в ВК → убедиться, что дубль не создаётся (и при включённом режиме редактирования — обновляется сообщение).
- [ ] Финальный тест модерации: пост идёт в личку владельца с кнопками, при Approve публикуется в канал, при Reject — нет записи, статус `rejected`.
