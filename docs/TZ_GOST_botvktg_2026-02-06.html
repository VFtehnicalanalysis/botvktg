<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Техническое задание по ГОСТ — бот VK/Site → Telegram</title>
  <style>
    body { font-family: "Times New Roman", serif; font-size: 14pt; line-height: 1.35; margin: 2cm; }
    h1 { font-size: 18pt; text-align: center; margin: 0 0 24px 0; }
    h2 { font-size: 16pt; margin: 18px 0 10px 0; }
    p { margin: 6px 0; }
    ul { margin: 6px 0 10px 24px; }
    table { border-collapse: collapse; width: 100%; margin: 10px 0; }
    th, td { border: 1px solid #000; padding: 6px 8px; vertical-align: top; }
    .center { text-align: center; }
  </style>
</head>
<body>
  <p class="center">УТВЕРЖДАЮ</p>
  <p class="center">________________ /______________/</p>
  <p class="center">"____" ____________ 2026 г.</p>
  <br />
  <h1>Техническое задание<br/>на программное средство<br/>«Бот ретрансляции VK/Site → Telegram»</h1>
  <p class="center">(по структуре ГОСТ 34.602-89, с учетом ГОСТ 19.201-78)</p>
  <p class="center">Редакция по фактической реализации на 06.02.2026</p>

  <h2>1. Общие сведения</h2>
  <p>1.1. Наименование: программное средство «Бот ретрансляции VK/Site → Telegram» (далее — Бот).</p>
  <p>1.2. Основание для разработки: внутренняя потребность в автоматизации публикации контента в Telegram-канал.</p>
  <p>1.3. Область применения: публикация контента из сообщества VK и новостного раздела сайта alumni экономического факультета МГУ в Telegram-канал с модерацией владельцем.</p>
  <p>1.4. Дата фиксации объема реализации: 06.02.2026.</p>

  <h2>2. Назначение и цели создания (эксплуатации) системы</h2>
  <p>2.1. Назначение Бота:</p>
  <ul>
    <li>автоматизированный прием постов из VK и новостей сайта alumni;</li>
    <li>передача контента в Telegram-канал после модерации или автоматически (в зависимости от режима);</li>
    <li>хранение состояния обработки для защиты от дублей.</li>
  </ul>
  <p>2.2. Цели:</p>
  <ul>
    <li>сокращение ручных операций по публикации контента;</li>
    <li>обеспечение контролируемой публикации через Telegram-владельца;</li>
    <li>повышение устойчивости к сетевым сбоям за счет повторных попыток и сохранения состояния.</li>
  </ul>

  <h2>3. Характеристика объекта автоматизации</h2>
  <p>3.1. Объект автоматизации: процесс публикации контента из источников:</p>
  <ul>
    <li>сообщество VK (Long Poll + резервный опрос wall.get);</li>
    <li>сайт https://www.econ.msu.ru/alumni/ (лента событий и карточки новостей).</li>
  </ul>
  <p>3.2. Приемник: Telegram-канал, заданный параметром <code>TG_CHANNEL_ID</code>.</p>
  <p>3.3. Оператор/модератор: владелец бота (<code>OWNER_ID</code>).</p>

  <h2>4. Требования к системе</h2>

  <p><b>4.1. Требования к структуре и функционированию</b></p>
  <p>4.1.1. Бот реализован как асинхронное приложение на Python.</p>
  <p>4.1.2. Поддерживаются режимы источников (<code>SOURCE_MODE</code>): <code>vk</code>, <code>site</code>, <code>vk+site</code>.</p>
  <p>4.1.3. Запускаемые фоновые процессы:</p>
  <ul>
    <li>цикл VK Long Poll;</li>
    <li>резервный цикл опроса VK wall.get;</li>
    <li>цикл Telegram callback/message для обработки кнопок и команд;</li>
    <li>цикл опроса сайта (при включенном источнике site).</li>
  </ul>

  <p><b>4.2. Функциональные требования (реализованный объем)</b></p>
  <p>4.2.1. Обработка VK-постов:</p>
  <ul>
    <li>получение событий <code>wall_post_new</code> и <code>wall_post_edit</code>;</li>
    <li>фильтрация неподходящих типов постов (<code>suggest</code>, <code>postpone</code>);</li>
    <li>нормализация текста и вложений (фото, видео-ссылки, документы-ссылки, опросы, copy_history);</li>
    <li>дедупликация по хэшу контента и статусу записи.</li>
  </ul>
  <p>4.2.2. Публикация в Telegram для VK-постов:</p>
  <ul>
    <li>разбиение длинного текста на части;</li>
    <li>отправка фото (одно фото с caption, несколько фото через media group);</li>
    <li>отдельная отправка опросов Telegram Poll;</li>
    <li>fallback при неудачной media group: отправка по одному фото.</li>
  </ul>
  <p>4.2.3. Модерация VK-постов:</p>
  <ul>
    <li>режимы <code>MODERATION_MODE=required|off</code>;</li>
    <li>в режиме required — отправка предпросмотра владельцу и обработка inline-кнопок;</li>
    <li>хранение токенов модерации и удаление сообщений модерации после решения;</li>
    <li>для действий «ВК/ВК+TG» по исходному VK-посту новая запись в VK не создается (фиксируется решение, публикация в TG выполняется по выбранному действию).</li>
  </ul>
  <p>4.2.4. Обработка новостей сайта:</p>
  <ul>
    <li>получение последней новости из ленты событий alumni с fallback на старую верстку;</li>
    <li>парсинг карточки новости: заголовок, дата, основной текст, изображения;</li>
    <li>поддержка ссылок типов news/article/events/digest;</li>
    <li>выявление и специальная обработка дайджестов (включая маркеры «читать далее» и ограничение до 1 изображения);</li>
    <li>очистка текста от служебных блоков и дублирующихся/служебных строк.</li>
  </ul>
  <p>4.2.5. Публикация новостей:</p>
  <ul>
    <li>в Telegram: текст + до 10 изображений (для дайджеста — 1);</li>
    <li>в VK: публикация текста через <code>wall.post</code>, загрузка до 10 изображений через API загрузки фотографий;</li>
    <li>fallback для VK при ограничениях токена/ошибках вложений: публикация без вложений;</li>
    <li>модерация новостей с вариантами публикации: VK, TG, VK+TG, отклонить.</li>
  </ul>
  <p>4.2.6. Ручные действия владельца в Telegram:</p>
  <ul>
    <li>кнопки: «Обновить посты», «Крайний пост VK», «Крайняя новость сайта», «Новость по ссылке»;</li>
    <li>текстовые команды: <code>/refresh</code>, «обновить посты»;</li>
    <li>при отправке владельцем поддерживаемой ссылки новости — форс-обработка этой новости.</li>
  </ul>

  <p><b>4.3. Требования к надежности</b></p>
  <p>4.3.1. Для VK-цикла и цикла сайта реализована остановка с уведомлением владельца после 5 одинаковых ошибок подряд.</p>
  <p>4.3.2. Для Telegram API реализована обработка 429 с ожиданием <code>retry_after</code>.</p>
  <p>4.3.3. При повреждении файла состояния выполняется резервирование в <code>*.bak</code> и старт с чистым состоянием.</p>
  <p>4.3.4. Логи пишутся в stdout и в ротационный файл <code>logs/bot.log</code> (5 МБ, 3 резервных файла).</p>

  <p><b>4.4. Требования к информационному обеспечению</b></p>
  <p>4.4.1. Хранилище состояния: JSON-файл <code>state.json</code>.</p>
  <p>4.4.2. Хранимые данные: <code>last_ts</code>, записи постов и новостей, статусы модерации, токены, идентификаторы сообщений Telegram, список обработанных сущностей.</p>

  <p><b>4.5. Требования к программному обеспечению</b></p>
  <p>4.5.1. Язык реализации: Python 3.11+.</p>
  <p>4.5.2. Внешняя зависимость проекта: <code>httpx==0.27.0</code>.</p>
  <p>4.5.3. Запуск: <code>python -m bot</code> или <code>python main.py</code> (поддержан флаг <code>--dry-run</code>).</p>

  <p><b>4.6. Требования к защите информации</b></p>
  <p>4.6.1. Секреты (токены/ID) загружаются из переменных окружения и/или файла <code>password</code>.</p>
  <p>4.6.2. Токены не предназначены для вывода в эксплуатационные отчеты и журналы.</p>

  <p><b>4.7. Ограничения текущей реализации</b></p>
  <ul>
    <li>автоматическое редактирование ранее опубликованных сообщений Telegram при изменении VK-поста не реализовано (повторно одинаковый контент пропускается);</li>
    <li>в проекте отсутствует встроенный веб-интерфейс администрирования;</li>
    <li>хранилище состояния реализовано в JSON, СУБД не используется;</li>
    <li>автоматизированный комплект тестов в репозитории отсутствует.</li>
  </ul>

  <h2>5. Состав и содержание работ (по факту реализации)</h2>
  <p>5.1. Реализованы модули:</p>
  <ul>
    <li>конфигурация и запуск (<code>bot/config.py</code>, <code>bot/main.py</code>);</li>
    <li>VK-клиент (<code>bot/vk_client.py</code>);</li>
    <li>Telegram-клиент (<code>bot/tg_client.py</code>);</li>
    <li>парсер сайта (<code>bot/site_client.py</code>);</li>
    <li>пайплайн обработки и модерации (<code>bot/pipeline.py</code>);</li>
    <li>хранилище состояния (<code>bot/state.py</code>);</li>
    <li>логирование (<code>bot/logging_setup.py</code>).</li>
  </ul>

  <h2>6. Порядок контроля и приемки</h2>
  <p>6.1. Приемка выполняется по сценарному тестированию в рабочем окружении:</p>
  <ul>
    <li>появление нового поста VK приводит к отправке на модерацию/в канал в соответствии с режимом;</li>
    <li>модерация кнопками приводит к корректному статусу (опубликовано/отклонено) и удалению сообщений модерации;</li>
    <li>ручная команда обновления инициирует повторную проверку источников без дублей;</li>
    <li>новость сайта публикуется в TG и/или VK по выбранному действию;</li>
    <li>после перезапуска состояние сохраняется, дублирование ранее обработанного контента не происходит.</li>
  </ul>

  <h2>7. Требования к подготовке объекта автоматизации к вводу в действие</h2>
  <p>7.1. Должны быть подготовлены:</p>
  <ul>
    <li>токены и идентификаторы: <code>VK_GROUP_ID</code>, <code>VK_GROUP_TOKEN</code>, <code>VK_USER_TOKEN</code> (для wall.get/upload), <code>TG_BOT_TOKEN</code>, <code>TG_CHANNEL_ID</code>, <code>OWNER_ID</code>;</li>
    <li>доступ бота в целевой Telegram-канал с правами публикации;</li>
    <li>доступ к сети Интернет по HTTPS.</li>
  </ul>

  <h2>8. Требования к документации</h2>
  <p>8.1. Эксплуатационная документация текущего объема включает:</p>
  <ul>
    <li>настоящее ТЗ;</li>
    <li>документ «Системные требования для развёртывания ВМ».</li>
  </ul>

  <h2>9. Источники разработки</h2>
  <p>9.1. Исходный код проекта в каталоге:</p>
  <ul>
    <li><code>bot/main.py</code>, <code>bot/pipeline.py</code>, <code>bot/site_client.py</code>, <code>bot/vk_client.py</code>, <code>bot/tg_client.py</code>, <code>bot/state.py</code>, <code>bot/config.py</code>, <code>bot/logging_setup.py</code>;</li>
    <li><code>requirements.txt</code> (список зависимостей).</li>
  </ul>

</body>
</html>
